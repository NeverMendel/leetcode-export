import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, InputFile
import re
from datetime import datetime
import csv
import os

TOKEN = '8083186134:AAGQrnQy0xph9kSImmI5OXHWp7hatWszzLY'
ADMIN_CHAT_ID = 1712853053
MONOBANK_CARD = "4441 1110 2811 6410"
MY_TELEGRAM_USERNAME = "@piec0_0eace"
REVIEW_CHANNEL_ID = '@piec_eace_Shop'

bot = telebot.TeleBot(TOKEN)

user_carts = {}
cancelled_carts = {}
order_counter = {}
orders_db = {}
reviews_db = {}

category_items = {
    "üõ° –ë—Ä–æ–Ω—è": {
        "–®–ª–µ–º 6": "5 –≥—Ä–Ω‚ôï", "–ë—Ä–æ–Ω—è 6": "5 –≥—Ä–Ω‚ôï",
        "–ö–æ–±—Ä–∞ —à–ª–µ–º 6": "10 –≥—Ä–Ω‚ôï", "–ö–æ–±—Ä–∞ –±—Ä–æ–Ω—è 6": "10 –≥—Ä–Ω‚ôï",
        "–°—Ç–∞–ª–∏–∫ —à–ª–µ–º 6": "10 –≥—Ä–Ω‚ôï", "–°—Ç–∞–ª–∏–∫ –±—Ä–æ–Ω—è 6": "10 –≥—Ä–Ω‚ôï",
        "–†—é–∫–∑–∞–∫ 6": "5 –≥—Ä–Ω‚ôï"
    },
    "üî´ –ó–±—Ä–æ—è": {
        "–ú–ö14 –≤–∏—à.": "5 –≥—Ä–Ω‚ôï", "–ú–ö14 –∫–±.": "10 –≥—Ä–Ω‚ôï",
        "–ú–ö14 —Å—Ñ.": "10 –≥—Ä–Ω‚ôï", "–ú–ì3 –≤–∏—à.": "10 –≥—Ä–Ω‚ôï"
    },
    "üõí –°–µ—Ç–∏": {
        "–°–µ—Ç '–ï–ª—ñ—Ç–∞'": "20 –≥—Ä–Ω‚ôï", "–°–µ—Ç '–ì–µ—Ä–æ–π'": "35 –≥—Ä–Ω‚ôï", "–°–µ—Ç '–õ–µ–≥–µ–Ω–¥–∞'": "35 –≥—Ä–Ω‚ôï"
    },
    "üÜï –°—É–ø—Ä–æ–≤–æ–¥–∏": {
        "–ó–≤–∏—á–∞–π–Ω–∏–π –Ω–∞ 5 –∫–∞—Ä—Ç—É": "50 –≥—Ä–Ω‚ôï", "–ü–æ —Ç—ñ–ø–∞–º –Ω–∞ 5 –∫–∞—Ä—Ç—É": "125 –≥—Ä–Ω‚ôï",
        "VIP –Ω–∞ 5 –∫–∞—Ä—Ç—É": "175 –≥—Ä–Ω‚ôï", "–ó–≤–∏—á–∞–π–Ω–∏–π –Ω–∞ 7 –∫–∞—Ä—Ç—É": "75 –≥—Ä–Ω‚ôï",
        "–ü–æ —Ç—ñ–ø–∞–º –Ω–∞ 7 –∫–∞—Ä—Ç—É": "125 –≥—Ä–Ω‚ôï", "VIP –Ω–∞ 7 –∫–∞—Ä—Ç—É": "200 –≥—Ä–Ω‚ôï",
        "VIP GOLD": "250 –≥—Ä–Ω‚ôï"
    },
    "üí∏ –ë—É—Å—Ç": {
        "–ë—ñ–ª–µ—Ç–∏ 20—à—Ç": "200 –≥—Ä–Ω", "–ë—ñ–ª–µ—Ç–∏ 50—à—Ç": "500 –≥—Ä–Ω", "–ë—ñ–ª–µ—Ç–∏ 100—à—Ç": "900 –≥—Ä–Ω",
        "–ë–∞–ª–∞–Ω—Å 20 –º–ª–Ω": "125 –≥—Ä–Ω", "–ë–∞–ª–∞–Ω—Å 50 –º–ª–Ω": "300 –≥—Ä–Ω", "–ë–∞–ª–∞–Ω—Å 100 –º–ª–Ω": "500 –≥—Ä–Ω",
        "–ë–∞–ª–∞–Ω—Å 500 –º–ª–Ω": "2100 –≥—Ä–Ω", "–ë–∞–ª–∞–Ω—Å 1 –º–ª—Ä–¥": "4000 –≥—Ä–Ω",
        "VIP –ë–∞–ª–∞–Ω—Å 20 –º–ª–Ω": "200 –≥—Ä–Ω", "VIP –ë–∞–ª–∞–Ω—Å 50 –º–ª–Ω": "400 –≥—Ä–Ω",
        "VIP –ë–∞–ª–∞–Ω—Å 100 –º–ª–Ω": "700 –≥—Ä–Ω", "VIP –ë–∞–ª–∞–Ω—Å 500 –º–ª–Ω": "3250 –≥—Ä–Ω",
        "VIP –ë–∞–ª–∞–Ω—Å 1 –º–ª—Ä–¥": "6500 –≥—Ä–Ω"
    }
}

status_map = {
    'pending': '‚è≥ –û—á—ñ–∫—É—î',
    'in_progress': 'üöß –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è',
    'done': '‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ',
    'rejected': '‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ',
    'processing': 'üöß –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è', 
    'completed': '‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ',     
    'cancelled': '‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ'    
}

# –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ
def parse_price(price_text):

    numbers = re.findall(r'\d+', price_text)
    return int(numbers[0]) if numbers else 0

def calculate_total(cart):
    return sum(parse_price(item['price']) for item in cart)

# /start
@bot.message_handler(commands=['start'])
def start(message):
    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    for category in category_items:
        markup.add(KeyboardButton(category))
    markup.add(KeyboardButton("üõí –ö–æ—à–∏–∫"), KeyboardButton("üì¶ –ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"))
    bot.send_message(message.chat.id, "üëã –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ! –û–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:", reply_markup=markup)

# –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó
@bot.message_handler(func=lambda m: m.text in category_items)
def show_items(message):
    markup = InlineKeyboardMarkup()
    for item, price in category_items[message.text].items():
        markup.add(InlineKeyboardButton(f"{item} - {price}", callback_data=f"add:{item}"))
    bot.send_message(message.chat.id, f"üîΩ –û–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä —É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó {message.text}:", reply_markup=markup)

# –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫
@bot.callback_query_handler(func=lambda call: call.data.startswith("add:"))
def add_to_cart(call):
    item = call.data.split(":")[1]
    price = None
    for cat in category_items:
        if item in category_items[cat]:
            price = category_items[cat][item]
            break
    if not price:
        bot.answer_callback_query(call.id, "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        return
    user_carts.setdefault(call.from_user.id, []).append({"item": item, "price": price})
    bot.answer_callback_query(call.id, f"‚úÖ {item} –¥–æ–¥–∞–Ω–æ —É –∫–æ—à–∏–∫")

# –ö–æ—à–∏–∫
@bot.message_handler(func=lambda m: m.text == "üõí –ö–æ—à–∏–∫")
def view_cart(message):
    cart = user_carts.get(message.from_user.id, [])
    if not cart:
        bot.send_message(message.chat.id, "üõí –í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π")
        return
    total = calculate_total(cart)

    text = "üõí –í–∞—à—ñ —Ç–æ–≤–∞—Ä–∏:\n" + "\n".join([f"- {i['item']} ({i['price']})" for i in cart]) + f"\n\nüí∞ –í—Å—å–æ–≥–æ: {total} –≥—Ä–Ω"
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("‚úÖ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", callback_data="checkout"))
    markup.add(InlineKeyboardButton("üóë –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫", callback_data="clearcart"))
    bot.send_message(message.chat.id, text, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "clearcart")
def clear_cart(call):
    uid = call.from_user.id

    user_carts[uid] = []
    bot.answer_callback_query(call.id, "üóë –ö–æ—à–∏–∫ –æ—á–∏—â–µ–Ω–æ")

# –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
@bot.callback_query_handler(func=lambda call: call.data == "checkout")
def ask_player_id(call):

    cart = user_carts.get(call.from_user.id, [])
    if not cart:
        bot.answer_callback_query(call.id, "‚ùå –í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è–º.")
        return

    bot.send_message(call.from_user.id, "üéÆ –í–≤–µ–¥—ñ—Ç—å ID –≥—Ä–∞–≤—Ü—è (–∞–±–æ –Ω—ñ–∫):")

    bot.register_next_step_handler(call.message, complete_order)

def complete_order(message):
    user_id = message.from_user.id
    cart = user_carts.get(user_id, [])
    if not cart:
        bot.send_message(user_id, "‚ùå –ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è–º.")
        return

    total = calculate_total(cart)
    order_counter.setdefault(user_id, 0)
    order_counter[user_id] += 1
    counter = order_counter[user_id]
    order_id = f"{user_id}_{counter}"

    order = {
        "order_id": order_id,
        "user_id": user_id,
        "username": message.from_user.username if message.from_user.username else "N/A", 
        "player_id": message.text,
        "cart": cart,
        "total": total,
        "status": "pending" 
    }
    orders_db[order_id] = order
    user_carts[user_id] = [] 

    admin_markup = InlineKeyboardMarkup()
    admin_markup.add(
        InlineKeyboardButton("üöß –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è", callback_data=f"progress:{order_id}"),
        InlineKeyboardButton("‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ", callback_data=f"done:{order_id}"), 
        InlineKeyboardButton("‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏", callback_data=f"reject:{order_id}")
    )
    order_text = f"üì¶ –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #{order_id}\nüë§ @{order['username']} ({user_id})\nüéÆ ID –≥—Ä–∞–≤—Ü—è: {order['player_id']}\nüí∞ –°—É–º–∞: {total} –≥—Ä–Ω\nüõí –¢–æ–≤–∞—Ä–∏:\n" + "\n".join([f"- {i['item']} ({i['price']})" for i in cart])
    bot.send_message(ADMIN_CHAT_ID, order_text, reply_markup=admin_markup)
    bot.send_message(user_id, f"‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order_id} —Å—Ç–≤–æ—Ä–µ–Ω–æ!\nüí≥ –û–ø–ª–∞—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É: {MONOBANK_CARD}\n–ó–≤ º—è–∂—ñ—Ç—å—Å—è –∑ –ø—Ä–æ–¥–∞–≤—Ü–µ–º: {MY_TELEGRAM_USERNAME}")

@bot.callback_query_handler(func=lambda call: call.data.startswith(("done:", "progress:", "reject:")))
def update_status_legacy(call):
    action, order_id = call.data.split(":")
    if order_id in orders_db:

        new_status = {
            'done': 'completed',
            'progress': 'processing',
            'reject': 'cancelled'
        }[action]
        orders_db[order_id]['status'] = new_status
        status_text = status_map[new_status]
        bot.send_message(orders_db[order_id]['user_id'], f"‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order_id} –æ–Ω–æ–≤–ª–µ–Ω–æ: {status_text}")
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=None)
    else:
        bot.answer_callback_query(call.id, "‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")

# /myorders
@bot.message_handler(commands=['myorders', '–º–æ—ó_–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è']) 
def my_orders(message):
    uid = message.from_user.id

    my = [v for v in orders_db.values() if v.get('user_id') == uid]
    if not my:
        bot.send_message(uid, "üì¶ –£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å.")
        return

    for o in my:
        status_display = status_map.get(o.get('status', 'unknown'), '–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å')
        bot.send_message(uid, f"#{o['order_id']} - {status_display} - {o['total']} –≥—Ä–Ω")


@bot.message_handler(commands=['findorder', '–∑–Ω–∞–π—Ç–∏_–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è'])
def find_order(message):
    if message.chat.id != ADMIN_CHAT_ID:
        return
    msg = bot.send_message(message.chat.id, "üîç –í–≤–µ–¥–∏ ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:")
    bot.register_next_step_handler(msg, show_order_info)

def show_order_info(message):
    order_id = message.text.strip()
    order = orders_db.get(order_id)
    if not order:
        bot.send_message(message.chat.id, "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —Ç–∞–∫–∏–º ID.")
        return

    text = f"üì¶ –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #{order_id}\nüë§ @{order['username']} ({order['user_id']})\nüéÆ ID –≥—Ä–∞–≤—Ü—è: {order['player_id']}\nüí∞ –°—É–º–∞: {order['total']} –≥—Ä–Ω\n–°—Ç–∞—Ç—É—Å: {status_map[order['status']]}\n–¢–æ–≤–∞—Ä–∏:\n" + "\n".join([f"- {i['item']} ({i['price']})" for i in order['cart']])
    bot.send_message(message.chat.id, text)

# /allorders (Admin only)
@bot.message_handler(commands=['allorders', '–≤—Å—ñ_–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è'])
def all_orders(message):
    if message.chat.id != ADMIN_CHAT_ID:
        return
    if not orders_db:
        bot.send_message(message.chat.id, "‚ùå –ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å.")
        return

    for order in orders_db.values():
        status_display = status_map.get(order.get('status', 'unknown'), '–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å')
        bot.send_message(message.chat.id, f"#{order['order_id']} - {status_display} - {order['total']} –≥—Ä–Ω")

# /exportorders (Admin only)
@bot.message_handler(commands=['exportorders', '–µ–∫—Å–ø–æ—Ä—Ç_–∑–∞–º–æ–≤–ª–µ–Ω—å'])
def export_orders(message):
    if message.chat.id != ADMIN_CHAT_ID:
        return
    filename = "orders_export.csv"
    try:
        with open(filename, "w", newline='', encoding='utf-8') as csvfile:
            fieldnames = ['order_id', 'user_id', 'username', 'player_id', 'total', 'status', 'items']
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            writer.writeheader()
            for order in orders_db.values():
                writer.writerow({
                    'order_id': order.get('order_id', 'N/A'),
                    'user_id': order.get('user_id', 'N/A'),
                    'username': order.get('username', 'N/A'),
                    'player_id': order.get('player_id', 'N/A'),
                    'total': order.get('total', 0),
                    'status': order.get('status', 'N/A'),
                    'items': "; ".join([item.get('item', 'N/A') for item in order.get('cart', [])])
                })
        bot.send_document(message.chat.id, InputFile(filename))
    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç—ñ –∑–∞–º–æ–≤–ª–µ–Ω—å: {e}")
    finally:
        if os.path.exists(filename):
            os.remove(filename)

# /ordersbyuser (Admin only)
@bot.message_handler(commands=['ordersbyuser', '–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è_–ø–æ_–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É'])
def orders_by_user(message):
    if message.chat.id != ADMIN_CHAT_ID:
        return
    msg = bot.send_message(message.chat.id, "üîé –í–≤–µ–¥–∏ user_id –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∑–∞–º–æ–≤–ª–µ–Ω—å:")
    bot.register_next_step_handler(msg, show_orders_for_user)

def show_orders_for_user(message):
    try:
        uid = int(message.text.strip())
        user_orders = [v for v in orders_db.values() if v.get('user_id') == uid]
        if not user_orders:
            bot.send_message(message.chat.id, "‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.")
            return
        for order in user_orders:
            status_display = status_map.get(order.get('status', 'unknown'), '–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å')
            bot.send_message(message.chat.id, f"#{order['order_id']} ({status_display}) - {order['total']} –≥—Ä–Ω")
    except ValueError: 
        bot.send_message(message.chat.id, "‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π user_id. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è.")
    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: {e}")


# –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å
@bot.message_handler(commands=['admin', '–∞–¥–º—ñ–Ω'])
def admin_panel(message):
    if message.chat.id != ADMIN_CHAT_ID:
        bot.send_message(message.chat.id, "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ.")
        return

    markup = InlineKeyboardMarkup(row_width=2)
    markup.add(
        InlineKeyboardButton("üì¶ –í—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", callback_data="admin_allorders"),
        InlineKeyboardButton("üîé –ü–æ—à—É–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", callback_data="admin_findorder"),
        InlineKeyboardButton("üë§ –ó–∞ user ID", callback_data="admin_ordersbyuser"),
        InlineKeyboardButton("üì§ –ï–∫—Å–ø–æ—Ä—Ç CSV", callback_data="admin_exportorders")
    )
    bot.send_message(message.chat.id, "üõ† <b>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</b>\n–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:", reply_markup=markup, parse_mode="HTML")

# –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫ –∑ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ
@bot.callback_query_handler(func=lambda call: call.data.startswith("admin_"))
def handle_admin_action(call):
    if call.message.chat.id != ADMIN_CHAT_ID:
        bot.answer_callback_query(call.id, "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ.")
        return

    action = call.data

    if action == "admin_allorders":
        if not orders_db:
            bot.send_message(call.message.chat.id, "‚ùå –ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å.")
            bot.answer_callback_query(call.id)
            return

        for order_id, order in orders_db.items():
            status_display = status_map.get(order.get('status', 'unknown'), '–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å')
            msg = f"üÜî {order_id} ‚Äî {status_display} ‚Äî {order.get('total', 0)} –≥—Ä–Ω" 
            markup = InlineKeyboardMarkup()

            if order['status'] == "pending":
                markup.add(
                    InlineKeyboardButton("üöß –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è", callback_data=f"confirm_{order_id}"),
                    InlineKeyboardButton("‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏", callback_data=f"reject_{order_id}")
                )
            elif order['status'] == "processing":
                markup.add(
                    InlineKeyboardButton("‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ", callback_data=f"complete_{order_id}")
                )
            bot.send_message(call.message.chat.id, msg, reply_markup=markup)

    elif action == "admin_findorder":
        msg = bot.send_message(call.message.chat.id, "üîé –í–≤–µ–¥–∏ ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:")
        bot.register_next_step_handler(msg, show_order_info)

    elif action == "admin_ordersbyuser":
        msg = bot.send_message(call.message.chat.id, "üßë –í–≤–µ–¥–∏ user_id:")
        bot.register_next_step_handler(msg, show_orders_for_user) 

    elif action == "admin_exportorders":
        export_orders(call.message) 

    bot.answer_callback_query(call.id)

# –û–±—Ä–æ–±–∫–∞ —Å—Ç–∞—Ç—É—Å—ñ–≤: –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è, –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è
@bot.callback_query_handler(func=lambda call: call.data.startswith(("confirm_", "reject_", "complete_")))
def handle_order_status_change(call):
    if call.message.chat.id != ADMIN_CHAT_ID:
        bot.answer_callback_query(call.id, "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ.")
        return

    action, order_id = call.data.split("_", 1)
    order = orders_db.get(order_id)

    if not order:
        bot.answer_callback_query(call.id, "‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        return

    user_id = order["user_id"]

    if action == "confirm":
        order["status"] = "processing"
        markup = InlineKeyboardMarkup().add(
            InlineKeyboardButton("‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ", callback_data=f"complete_{order_id}")
        )
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=markup)
        bot.send_message(user_id, f"üöß –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è *{order_id}* –∑–∞—Ä–∞–∑ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è.", parse_mode="Markdown")
        bot.send_message(call.message.chat.id, f"üöß –°—Ç–∞—Ç—É—Å {order_id} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ *–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è*.", parse_mode="Markdown")

    elif action == "complete":
        order["status"] = "completed"
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=None)
        bot.send_message(user_id, f"‚úÖ –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è *{order_id}* –≤–∏–∫–æ–Ω–∞–Ω–æ!", parse_mode="Markdown")
        bot.send_message(call.message.chat.id, f"‚úÖ –°—Ç–∞—Ç—É—Å {order_id} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ *–í–∏–∫–æ–Ω–∞–Ω–æ*.", parse_mode="Markdown")
        send_review_rating_request(user_id, order_id)

    elif action == "reject":
        order["status"] = "cancelled"
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=None)
        bot.send_message(user_id, f"‚ùå –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è *{order_id}* –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ.", parse_mode="Markdown")
        bot.send_message(call.message.chat.id, f"‚ùå –°—Ç–∞—Ç—É—Å {order_id} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ *–í—ñ–¥—Ö–∏–ª–µ–Ω–æ*.", parse_mode="Markdown")

    bot.answer_callback_query(call.id) 

# ‚≠ê –ó–∞–ø–∏—Ç –Ω–∞ –∑—ñ—Ä–∫–∏
def send_review_rating_request(user_id, order_id):
    markup = InlineKeyboardMarkup(row_width=5)
    buttons = [InlineKeyboardButton(f"{i}‚≠ê", callback_data=f"reviewstars_{order_id}_{i}") for i in range(1, 6)]
    markup.add(*buttons)
    bot.send_message(
        user_id,
        f"‚úÖ –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order_id} –≤–∏–∫–æ–Ω–∞–Ω–æ!\n\nüìä –ë—É–¥—å –ª–∞—Å–∫–∞, –æ—Ü—ñ–Ω—ñ—Ç—å —Å–µ—Ä–≤—ñ—Å:",
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith("reviewstars_"))
def handle_review_stars(call):
    try:
        _, order_id, stars = call.data.split("_", 2)
        stars = int(stars)
        user_id = call.from_user.id
        reviews_db[order_id] = {"user_id": user_id, "stars": stars, "text": ""}
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=None)
        bot.send_message(
            call.message.chat.id,
            f"‚≠ê –í–∏ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ {stars} –∑ 5. –¢–µ–ø–µ—Ä –Ω–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫ —Ç–µ–∫—Å—Ç–æ–º —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:"
        )
        bot.register_next_step_handler(call.message, lambda msg: save_review_text(msg, order_id, stars))
    except Exception as e:
        print(f"[review stars error] {e}")
        bot.answer_callback_query(call.id, "‚ùå –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

# üí¨ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É + –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è
def save_review_text(message, order_id, stars):
    text = message.text
    user_id = message.from_user.id


    if order_id in reviews_db:
        reviews_db[order_id]["text"] = text
    else:
        reviews_db[order_id] = {"user_id": user_id, "stars": stars, "text": text}

    bot.send_message(message.chat.id, "‚úÖ –î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à –≤—ñ–¥–≥—É–∫!")
    bot.send_message(
        ADMIN_CHAT_ID,
        f"üí¨ –í—ñ–¥–≥—É–∫ –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—é #{order_id} –≤—ñ–¥ <a href='tg://user?id={user_id}'>–ø–æ–∫—É–ø—Ü—è</a>:\n\n"
        f"‚≠ê {stars} –∑ 5\n{text}",
        parse_mode="HTML"
    )

    try:
        star_line = "‚≠ê" * stars
        bot.send_message(
            REVIEW_CHANNEL_ID,
            f"üõí <b>–ù–æ–≤–∏–π –≤—ñ–¥–≥—É–∫</b>\n\n{star_line}\n{text}",
            parse_mode="HTML"
        )
    except Exception as e:
        print(f"[publish review error] {e}")
        bot.send_message(ADMIN_CHAT_ID, f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –≤—ñ–¥–≥—É–∫—É –≤ –∫–∞–Ω–∞–ª: {e}")

print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ")
bot.polling(none_stop=True)
